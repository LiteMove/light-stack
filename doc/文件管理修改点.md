在租户管理页面增加"文件存储配置"选项卡，允许管理员为每个租户配置：
- 存储类型（本地/OSS）支持多种oss
- 存储参数
- 文件大小限制
- 允许的文件类型
- 默认公开策略

1. 核心设计思路

  数据库模型扩展：
  -- 在File模型中增加字段
  ALTER TABLE files ADD COLUMN storage_type VARCHAR(20) DEFAULT 'local'; -- local/oss
  ALTER TABLE files ADD COLUMN is_public BOOLEAN DEFAULT false; -- 是否公开访问
  ALTER TABLE files ADD COLUMN access_url VARCHAR(1000); -- 完整访问URL

    2. 目录结构设计

  uploads/
  ├── public/                    # 公开访问文件
  │   ├── tenant_1/
  │   │   ├── 2024/01/01/
  │   │   └── ...
  │   └── tenant_2/
  └── private/                   # 需登录访问文件
  ├── tenant_1/
  │   ├── 2024/01/01/
  │   └── ...
  └── tenant_2/

    3. URL生成规则

  本地存储：
    - 公开文件：{base_url}/public/tenant_{tenant_id}/{date}/{filename}
    - 私有文件：{base_url}/private/tenant_{tenant_id}/{date}/{filename}

  OSS存储：
    - 公开文件：{oss_base_url}/public/tenant_{tenant_id}/{date}/{filename}
    - 私有文件：通过临时授权URL访问

    4. 实现要点

    1. 存储抽象接口：
       type StorageProvider interface {
       Upload(file io.Reader, path string) (string, error)
       GetURL(path string, isPublic bool) string
       Delete(path string) error
       }

    2. 中间件增强：
    - 静态文件服务中间件处理public目录
    - 私有文件访问需要权限验证
    3. 模型字段增加：
    - StorageType：存储类型
    - IsPublic：是否公开
    - AccessURL：完整访问URL

✻ Thinking…

现在我需要提供具体的实现建议，包括代码修改步骤和具体的实现方式。

● 具体实现建议

第一步：配置文件扩展

在 internal/config/config.go 中添加存储配置：

type StorageConfig struct {
Type  string            `yaml:"type" json:"type"`   // local, oss
Local LocalStorageConfig `yaml:"local" json:"local"`
OSS   OSSStorageConfig   `yaml:"oss" json:"oss"`
}

type LocalStorageConfig struct {
BaseURL    string `yaml:"base_url" json:"base_url"`
UploadPath string `yaml:"upload_path" json:"upload_path"`
}

type OSSStorageConfig struct {
Endpoint  string `yaml:"endpoint" json:"endpoint"`
Bucket    string `yaml:"bucket" json:"bucket"`
AccessKey string `yaml:"access_key" json:"access_key"`
SecretKey string `yaml:"secret_key" json:"secret_key"`
BaseURL   string `yaml:"base_url" json:"base_url"`
}

第二步：修改File模型

在 internal/model/file.go 中增加字段：

type File struct {
TenantBaseModel
// ... 现有字段
StorageType string `json:"storageType" gorm:"not null;default:'local';size:20"`
IsPublic    bool   `json:"isPublic" gorm:"not null;default:false"`
AccessURL   string `json:"accessUrl" gorm:"size:1000"`
}

第三步：创建存储抽象接口

新建 internal/storage/provider.go：

package storage

import "io"

type Provider interface {
Upload(file io.Reader, path string, isPublic bool) (string, error)
GetURL(path string, isPublic bool) string
Delete(path string) error
}

type Manager struct {
provider Provider
}

func NewManager(storageType string, config interface{}) *Manager {
var provider Provider
switch storageType {
case "local":
provider = NewLocalProvider(config.(LocalConfig))
case "oss":
provider = NewOSSProvider(config.(OSSConfig))
}
return &Manager{provider: provider}
}

第四步：修改FileService

在 internal/service/file_service.go 中：

1. 集成存储管理器
2. 修改上传逻辑以支持存储类型选择
3. 生成正确的访问URL

type FileService struct {
fileRepo       *repository.FileRepository
storageManager *storage.Manager
}

func (s *FileService) UploadFile(file *multipart.FileHeader, userID, tenantID uint64, usageType string, isPublic bool) (*model.File, error) {
// 生成存储路径
dateDir := time.Now().Format("2006/01/02")
accessType := "private"
if isPublic {
accessType = "public"
}

      storePath := fmt.Sprintf("%s/tenant_%d/%s/%s", accessType, tenantID, dateDir, fileName)

      // 上传到存储系统
      accessURL, err := s.storageManager.Upload(src, storePath, isPublic)
      if err != nil {
          return nil, err
      }

      // 保存文件记录
      fileModel.AccessURL = accessURL
      fileModel.IsPublic = isPublic
      // ...
}

第五步：添加静态文件服务

在路由中添加静态文件服务：

// 公开文件静态服务
router.Static("/static/public", "./uploads/public")

// 私有文件需要权限验证
private := router.Group("/static/private")
private.Use(middleware.AuthRequired())
private.Static("/", "./uploads/private")

第六步：前端调用优化

修改前端API调用，直接使用返回的 accessUrl 进行预览和下载。

这个方案的优势：
1. 简单易懂：通过配置文件控制存储类型
2. URL直接访问：文件可通过静态URL直接访问
3. 租户隔离：目录结构天然支持租户隔离
4. 权限控制：public/private目录分离，便于权限管理
5. 易于扩展：抽象接口设计，便于后续支持更多存储类型

# 文件存储管理系统开发任务拆分

## 项目概述

基于现有系统架构，开发完整的文件存储管理功能，支持租户级配置、多种存储方式、公有/私有访问控制。

## 总体目标

🎯 **核心功能**
- ✅ 支持本地存储/OSS存储切换
- ✅ 直接URL访问，无需经过API
- ✅ 租户级别目录隔离
- ✅ 公开/私有访问控制
- ✅ 个人中心配置管理

📁 **目录设计**
```
uploads/
├── public/tenant_1/2024/01/01/   # 公开文件
└── private/tenant_1/2024/01/01/  # 私有文件
```

🔗 **URL访问**
- 本地存储：
  - 公开：/static/public/tenant_1/2024/01/01/file.jpg
  - 私有：/static/private/tenant_1/2024/01/01/file.jpg (需登录)
- OSS存储：
  - 公开：{oss_domain}/public/tenant_1/2024/01/01/file.jpg
  - 私有：临时授权URL (需登录获取)

☁️ **支持的OSS平台 (架构预留)**
- 阿里云 OSS
- 腾讯云 COS
- AWS S3
- 七牛云 Kodo
- 又拍云 USS

---

## 🚀 开发任务详细拆分

### 阶段一：后端基础架构 (1-2天)

#### 任务1.1：数据库迁移和模型优化
**状态：** 🟡 待开始
**预估时间：** 2小时
**描述：** 为已有模型添加新字段支持

**子任务：**
- [ ] 1.1.1 检查File模型是否需要额外字段补充
- [ ] 1.1.2 检查Tenant模型配置结构是否完整
- [ ] 1.1.3 创建数据库迁移脚本
- [ ] 1.1.4 测试迁移脚本执行

**验收标准：**
- File模型包含StorageType、IsPublic、AccessURL字段
- Tenant模型Config字段支持FileStorageConfig结构
- 数据库迁移成功执行

---

#### 任务1.2：存储Provider架构实现
**状态：** 🟡 待开始
**预估时间：** 3小时
**描述：** 实现本地存储Provider，设计可扩展的OSS多平台架构

**子任务：**
- [ ] 1.2.1 实现LocalProvider (internal/storage/local.go)
  - 实现Upload方法（支持public/private目录）
  - 实现GetURL方法
  - 实现Delete方法
  - 实现GetFullPath方法
- [ ] 1.2.2 设计OSS多平台扩展架构
  - 定义通用OSS配置接口
  - 预留阿里云OSS、腾讯云COS、AWS S3等平台扩展点
  - 创建OSS Provider基础结构（暂不实现具体逻辑）
- [ ] 1.2.3 测试LocalProvider功能
- [ ] 1.2.4 验证OSS架构可扩展性

**验收标准：**
- LocalProvider能正确上传、获取URL、删除文件
- 支持public/private目录结构
- OSS架构设计支持多平台扩展（阿里云、腾讯云、AWS等）
- 配置结构支持不同OSS平台参数

---

#### 任务1.3：租户配置API开发
**状态：** 🟡 待开始
**预估时间：** 3小时
**描述：** 为租户管理添加文件存储配置接口

**子任务：**
- [ ] 1.3.1 在TenantController中添加配置相关接口：
  - GET /api/tenants/{id}/config - 获取租户配置
  - PUT /api/tenants/{id}/config - 更新租户配置
- [ ] 1.3.2 在TenantService中实现配置逻辑
- [ ] 1.3.3 添加配置验证规则

**验收标准：**
- 能获取和更新租户文件存储配置
- 配置验证正确（存储类型、文件大小限制等）
- API响应格式正确

---

### 阶段二：个人中心功能 (2-3天)

#### 任务2.1：个人中心后端接口开发
**状态：** 🟡 待开始
**预估时间：** 4小时
**描述：** 开发个人中心相关API

**子任务：**
- [ ] 2.1.1 创建UserProfileController (internal/controller/profile_controller.go)
  - GET /api/profile - 获取个人信息
  - PUT /api/profile - 更新个人信息
  - PUT /api/profile/password - 修改密码
- [ ] 2.1.2 为租户管理员添加配置接口：
  - GET /api/profile/tenant-config - 获取所在租户配置
  - PUT /api/profile/tenant-config - 更新所在租户配置（仅管理员）
- [ ] 2.1.3 创建ProfileService处理业务逻辑
- [ ] 2.1.4 添加权限验证中间件

**验收标准：**
- 用户能查看和修改个人信息
- 用户能修改密码（验证旧密码）
- 租户管理员能查看和修改租户配置
- 非管理员无法修改租户配置

---

#### 任务2.2：个人中心前端页面开发
**状态：** 🟡 待开始
**预估时间：** 6小时
**描述：** 开发个人中心Vue页面

**子任务：**
- [ ] 2.2.1 创建个人中心路由和页面结构
  - 创建 /web/src/views/profile/index.vue
  - 添加路由配置
- [ ] 2.2.2 开发个人信息标签页：
  - 个人信息显示和编辑表单
  - 密码修改表单
  - 表单验证逻辑
- [ ] 2.2.3 开发租户配置标签页（管理员可见）：
  - 文件存储配置表单
  - 存储类型切换（本地/OSS预留）
  - OSS平台选择（阿里云/腾讯云/AWS等，UI预留）
  - 配置参数设置
- [ ] 2.2.4 集成API调用和状态管理
- [ ] 2.2.5 添加页面权限控制

**验收标准：**
- 个人中心页面布局美观，功能完整
- 表单验证正确，提示友好
- 租户管理员能看到并修改租户配置
- 普通用户只能看到个人信息

---

### 阶段三：文件管理功能优化 (2-3天)

#### 任务3.1：文件上传功能改造
**状态：** 🟡 待开始
**预估时间：** 4小时
**描述：** 改造现有文件上传以支持新的存储架构

**子任务：**
- [ ] 3.1.1 修改FileService.UploadFile方法：
  - 集成StorageManager
  - 根据租户配置选择存储方式
  - 生成正确的AccessURL
  - 支持isPublic参数
- [ ] 3.1.2 修改FileController上传接口：
  - 添加isPublic参数支持
  - 检查文件类型和大小限制
  - 返回完整的文件信息包括AccessURL
- [ ] 3.1.3 测试文件上传功能

**验收标准：**
- 文件能根据租户配置上传到正确存储
- 生成正确的访问URL
- 支持公有/私有文件区分
- 遵循文件大小和类型限制

---

#### 任务3.2：静态文件服务配置
**状态：** 🟡 待开始
**预估时间：** 2小时
**描述：** 配置静态文件服务路由

**子任务：**
- [ ] 3.2.1 在routes.go中添加静态文件路由：
  - 公开文件：/static/public/*
  - 私有文件：/static/private/* (需认证)
- [ ] 3.2.2 创建私有文件访问中间件
- [ ] 3.2.3 测试静态文件访问

**验收标准：**
- 公开文件可直接通过URL访问
- 私有文件需要登录后才能访问
- 租户隔离正确，不能跨租户访问

---

#### 任务3.3：文件管理前端改造
**状态：** 🟡 待开始
**预估时间：** 4小时
**描述：** 改造现有文件管理页面

**子任务：**
- [ ] 3.3.1 修改文件上传组件：
  - 添加公有/私有选项
  - 显示存储类型信息
  - 根据租户配置显示限制信息
- [ ] 3.3.2 修改文件列表页面：
  - 显示存储类型和访问级别
  - 使用AccessURL进行预览和下载
  - 添加公有/私有标识
- [ ] 3.3.3 优化文件预览功能：
  - 直接使用AccessURL
  - 支持图片预览、文档下载
- [ ] 3.3.4 测试文件管理功能

**验收标准：**
- 文件上传支持公有/私有选择
- 文件列表正确显示存储信息
- 预览和下载功能正常
- UI友好，用户体验良好

---

### 阶段四：测试和优化 (1天)

#### 任务4.1：功能测试
**状态：** 🟡 待开始
**预估时间：** 4小时
**描述：** 全面测试所有功能

**子任务：**
- [ ] 4.1.1 测试租户配置功能
- [ ] 4.1.2 测试个人中心功能
- [ ] 4.1.3 测试文件上传和访问
- [ ] 4.1.4 测试权限控制
- [ ] 4.1.5 测试多租户隔离

**验收标准：**
- 所有功能正常工作
- 权限控制正确
- 多租户隔离有效

---

#### 任务4.2：文档更新和部署准备
**状态：** 🟡 待开始
**预估时间：** 2小时
**描述：** 更新文档和准备部署

**子任务：**
- [ ] 4.2.1 更新API文档
- [ ] 4.2.2 更新部署说明
- [ ] 4.2.3 创建配置示例
- [ ] 4.2.4 准备数据库迁移脚本

**验收标准：**
- 文档完整准确
- 部署步骤清晰
- 配置示例可用

---

## 📋 开发检查清单

### 后端检查项
- [ ] 数据库模型和迁移
- [ ] 存储Provider实现
- [ ] 租户配置API
- [ ] 个人中心API
- [ ] 文件上传改造
- [ ] 静态文件服务
- [ ] 权限控制中间件

### 前端检查项
- [ ] 个人中心页面
- [ ] 租户配置界面
- [ ] 文件上传组件
- [ ] 文件管理页面
- [ ] 权限控制逻辑

### 测试检查项
- [ ] 单元测试
- [ ] 集成测试
- [ ] 权限测试
- [ ] 多租户测试
- [ ] 性能测试

---

## ⚠️ 注意事项

1. **安全性**：确保私有文件访问权限控制正确
2. **性能**：优化文件上传和访问性能
3. **兼容性**：保持与现有系统的兼容性
4. **扩展性**：OSS架构预留多平台支持，便于后续扩展
5. **容错性**：添加适当的错误处理和回滚机制

**🔧 OSS扩展说明**
- 当前版本仅实现本地存储
- OSS配置接口和架构已预留，支持：
  - 阿里云OSS (aliyun)
  - 腾讯云COS (tencent)
  - AWS S3 (aws)
  - 七牛云Kodo (qiniu)
  - 又拍云USS (upyun)
- 前端UI已预留OSS平台选择功能
- 后续可按需实现具体OSS平台Provider

---

## 🎯 最终验收标准

✅ **功能完整性**
- 租户能配置文件存储方式
- 个人中心功能完整
- 文件上传、存储、访问正常

✅ **权限控制**
- 租户管理员能配置租户设置
- 普通用户只能修改个人信息
- 文件访问权限正确

✅ **多租户支持**
- 租户间文件完全隔离
- 配置独立生效
- URL访问安全

✅ **用户体验**
- 界面友好易用
- 操作流程顺畅
- 错误提示清晰