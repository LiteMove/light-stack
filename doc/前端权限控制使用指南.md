# 前端权限控制使用指南

## 概述

前端权限控制系统提供了两种权限检查方式：
1. **Vue指令方式**：`v-permission`、`v-role` 等指令
2. **v-if条件渲染方式**：`v-if="$hasPer('xxx')"`

## 权限检查方式对比

### 1. Vue指令方式

**适用场景**：
- 大多数标准Vue组件
- 需要简洁语法的场景
- 组件级权限控制

**语法示例**：
```vue
<!-- 权限指令 -->
<el-button v-permission="'system:user:create'">新建用户</el-button>
<el-button v-permission="['user:create', 'user:update']">批量操作</el-button>
<el-button v-permission.all="['user:read', 'user:write']">全部权限</el-button>

<!-- 角色指令 -->
<el-button v-role="'tenant_admin'">租户管理员操作</el-button>
<el-button v-role="['tenant_admin', 'super_admin']">管理员操作</el-button>

<!-- 综合权限指令 -->
<el-button v-auth="{ permissions: ['user:create'], roles: ['tenant_admin'] }">综合权限</el-button>

<!-- 管理员权限指令 -->
<el-button v-admin>租户管理员专用</el-button>
<el-button v-super-admin>超级管理员专用</el-button>
```

**特点**：
- ✅ 语法简洁
- ✅ 支持数组和对象参数
- ✅ 支持修饰符（如 `.all`）
- ❌ 在某些组件上可能不生效（如el-tooltip包裹的按钮）
- ❌ 在表格操作按钮中可能失效

### 2. v-if条件渲染方式

**适用场景**：
- 表格操作按钮
- 复杂嵌套组件（如el-tooltip包裹的按钮）
- 需要与其他条件组合的场景
- 对兼容性要求高的场景

### 2. 角色检查

```vue
<!-- 基础权限检查 -->
<el-button v-if="$hasPer('system:user:create')">新建用户</el-button>

<!-- 角色检查 -->
<el-button v-if="$hasRole('tenant_admin')">租户管理员操作</el-button>
<el-button v-if="$hasRole('super_admin')">超级管理员操作</el-button>

<!-- 多权限检查 -->
<el-button v-if="$hasAnyPer(['user:create', 'user:update'])">任一权限</el-button>
<el-button v-if="$hasAllPer(['user:read', 'user:write'])">全部权限</el-button>

<!-- 管理员检查 -->
<el-button v-if="$isAdmin()">租户管理员专用</el-button>
<el-button v-if="$isSuperAdmin()">超级管理员专用</el-button>

<!-- 组合条件 -->
<el-button v-if="$hasPer('user:delete') && !row.isSystem">删除用户</el-button>

<!-- 表格操作按钮（推荐用法）-->
<el-tooltip v-if="$hasPer('system:user:update')" content="编辑用户">
  <el-button @click="handleEdit(row)" :icon="Edit" />
</el-tooltip>
```

**特点**：
- ✅ 兼容性极佳，适用于所有组件
- ✅ 可以与其他条件组合使用
- ✅ 在表格操作按钮中完全正常工作
- ✅ 支持复杂的条件逻辑
- ❌ 语法相对冗长
- ❌ 需要添加`$`前缀

## 可用的权限检查函数

### 全局函数（v-if方式）

| 函数 | 参数 | 返回值 | 说明 |
|------|------|--------|------|
| `$hasPer(permission)` | `string` | `boolean` | 检查单个权限 |
| `$hasRole(role)` | `string` | `boolean` | 检查单个角色 |
| `$hasAnyPer(permissions)` | `string[]` | `boolean` | 检查是否拥有任一权限 |
| `$hasAllPer(permissions)` | `string[]` | `boolean` | 检查是否拥有全部权限 |
| `$hasAnyRole(roles)` | `string[]` | `boolean` | 检查是否拥有任一角色 |
| `$hasAllRole(roles)` | `string[]` | `boolean` | 检查是否拥有全部角色 |
| `$isAdmin()` | 无 | `boolean` | 检查是否为管理员 |
| `$isSuperAdmin()` | 无 | `boolean` | 检查是否为超级管理员 |
| `$hasAuth(config)` | `AuthConfig` | `boolean` | 综合权限检查 |

### Composition API（在script中使用）

```typescript
// 在 <script setup> 中使用
import { usePermission } from '@/utils/permission'

const {
  hasPermission,
  hasRole,
  hasAnyPermission,
  hasAllPermissions,
  isAdmin,
  isSuperAdmin
} = usePermission()

// 使用示例
const canEdit = computed(() => hasPermission('user:update'))
const isManager = computed(() => hasRole('manager'))
```

## 实际应用示例

### 表格操作按钮（推荐v-if方式）

```vue
<template>
  <el-table-column label="操作" width="200" align="center" fixed="right">
    <template #default="{ row }">
      <div class="action-buttons">
        <!-- 编辑按钮 -->
        <el-tooltip v-if="$hasPer('system:user:update')" content="编辑用户">
          <el-button type="primary" link size="small" :icon="Edit" @click="handleEdit(row)" />
        </el-tooltip>
        
        <!-- 分配角色按钮 -->
        <el-tooltip v-if="$hasPer('system:user:assign')" content="分配角色">
          <el-button 
            type="warning" 
            link 
            size="small" 
            :icon="Key" 
            @click="handleAssignRoles(row)"
            :disabled="row.id === 1" 
          />
        </el-tooltip>
        
        <!-- 删除按钮（组合条件）-->
        <el-tooltip v-if="$hasPer('system:user:delete') && !row.isSystem" content="删除用户">
          <el-button 
            type="danger" 
            link 
            size="small" 
            :icon="Delete" 
            @click="handleDelete(row)" 
          />
        </el-tooltip>
      </div>
    </template>
  </el-table-column>
</template>
```

### 页面操作按钮（指令方式）

```vue
<template>
  <div class="header-actions">
    <!-- 使用指令方式，语法更简洁 -->
    <el-button v-permission="'system:user:create'" type="primary" @click="handleAdd">
      新建用户
    </el-button>
    
    <el-button v-permission="'system:user:export'" @click="exportUsers">
      导出用户
    </el-button>
    
    <!-- 批量操作 -->
    <el-button v-permission="['system:user:update', 'system:user:delete']" @click="batchOperate">
      批量操作
    </el-button>
  </div>
</template>
```

### 复杂权限逻辑（v-if方式）

```vue
<template>
  <!-- 复杂的权限和业务逻辑组合 -->
  <el-button 
    v-if="$hasPer('user:update') && !user.isLocked && user.status === 'active'"
    @click="handleUpdate"
  >
    更新用户
  </el-button>
  
  <!-- 多重条件判断 -->
  <div v-if="$isAdmin() || ($hasRole('manager') && $hasPer('department:manage'))">
    <el-button>部门管理</el-button>
  </div>

  <!-- 租户管理员和超级管理员判断 -->
  <div v-if="$hasRole('tenant_admin') || $hasRole('super_admin')">
    <el-button>管理功能</el-button>
  </div>
</template>
```

## 最佳实践建议

### 1. 选择合适的方式

- **表格操作按钮** → 使用 `v-if="$hasPer()"`
- **页面级按钮** → 使用 `v-permission` 指令
- **复杂条件判断** → 使用 `v-if="$hasPer()"`
- **简单权限控制** → 使用 `v-permission` 指令

### 2. 权限命名规范

```javascript
// 推荐的权限命名格式：模块:资源:操作
'system:user:create'    // 系统模块-用户资源-创建操作
'system:user:update'    // 系统模块-用户资源-更新操作
'system:user:delete'    // 系统模块-用户资源-删除操作
'system:user:assign'    // 系统模块-用户资源-分配操作

// 角色命名
'tenant_admin'          // 租户管理员
'super_admin'           // 超级管理员  
'manager'               // 经理
'operator'              // 操作员
```

### 3. 性能优化

```vue
<template>
  <!-- 避免在循环中频繁调用权限检查 -->
  <!-- ❌ 不推荐 -->
  <div v-for="item in list" :key="item.id">
    <el-button v-if="$hasPer('user:update')" @click="edit(item)">编辑</el-button>
  </div>
  
  <!-- ✅ 推荐：提前计算权限 -->
  <div v-for="item in list" :key="item.id">
    <el-button v-if="canEdit" @click="edit(item)">编辑</el-button>
  </div>
</template>

<script setup>
// 在组件级别计算权限，避免重复计算
const canEdit = computed(() => hasPer('user:update'))
</script>
```

### 4. 调试技巧

```vue
<script setup>
import { useUserStore } from '@/store'

const userStore = useUserStore()

// 调试权限信息
console.log('用户权限:', userStore.permissions)
console.log('用户角色:', userStore.roles)
console.log('检查权限结果:', userStore.hasPermission('system:user:create'))
</script>
```

## 故障排除

### 1. 权限检查函数未定义

**错误**：`$hasPer is not defined`

**解决方案**：
- 确保已在 `main.ts` 中注册全局属性
- 检查 `env.d.ts` 中的类型声明

### 2. 指令不生效

**现象**：使用 `v-permission` 但元素仍然显示

**可能原因**：
- 权限数据未正确加载
- 指令应用在不支持的组件上

**解决方案**：
- 检查用户store中的权限数据
- 改用 `v-if="$hasPer()"` 方式

### 3. 表格操作按钮权限失效

**现象**：表格中的操作按钮权限控制不生效

**解决方案**：
- 将 `v-permission` 改为 `v-if="$hasPer()"`
- 确保权限检查应用在正确的元素上

## 升级指南

从指令方式迁移到v-if方式：

```vue
<!-- 迁移前 -->
<el-tooltip v-permission="'system:user:update'" content="编辑">
  <el-button @click="edit" />
</el-tooltip>

<!-- 迁移后 -->
<el-tooltip v-if="$hasPer('system:user:update')" content="编辑">
  <el-button @click="edit" />
</el-tooltip>
```

**迁移步骤**：
1. 将 `v-permission="'xxx'"` 改为 `v-if="$hasPer('xxx')"`
2. 将 `v-role="'xxx'"` 改为 `v-if="$hasRole('xxx')"`
3. 数组参数需要更改为对应的函数调用
4. 测试功能确保权限控制正常工作

## 总结

- **v-if方式** 兼容性更好，推荐用于表格操作按钮和复杂场景
- **指令方式** 语法简洁，推荐用于常规页面按钮
- 根据实际使用场景选择合适的方式
- 两种方式可以在同一个项目中混合使用