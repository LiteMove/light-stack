轻栈 - 轻量级 Go 后台脚手架项目设计文档

1. 项目概述
   1.1 项目名称
   轻栈（LightStack）
   1.2 项目简介
   轻栈是一款轻量级的 Go 后台脚手架，旨在为开发者提供快速构建企业级后台管理系统的基础框架。该框架集成用户管理、角色权限、菜单配置等核心功能，支持 SAAS 模式 —— 允许租户个性化配置系统标题、Logo 等展示信息，管理自有用户与产品，但系统核心菜单仅支持系统管理员操作，租户无修改权限，既保证平台统一性，又满足租户个性化需求。
   1.3 项目目标
   提供稳定、高效的前后端分离后台架构，降低开发门槛
   实现 “用户 - 角色 - 权限” 三级管控体系，确保权限安全
   支持多租户隔离，满足 SAAS 模式下的数据与配置独立需求
   保障系统可扩展性，支持后续功能迭代与业务场景扩展
   简化部署流程，支持 Docker 一键部署，适配多环境需求
2. 技术架构
   2.1 技术栈选型
   
   模块
   技术选型
   选型说明
   后端语言
   Go 1.18+
   高性能、轻量、并发友好，适合后台服务开发
   后端框架
   Gin
   轻量级 Web 框架，路由性能优异，中间件支持完善
   数据库
   MySQL 8.0+
   成熟稳定的关系型数据库，适配权限、租户等结构化数据
   前端框架
   Vue3 + Vite + Element Plus
   组件化开发效率高，Vite 构建速度快，Element Plus 提供丰富后台组件
   缓存
   Redis 6.0+
   用于会话存储、高频数据缓存，提升系统响应速度
   认证授权
   JWT（JSON Web Token）
   无状态认证，适配分布式部署场景
   API 文档
   Swagger
   自动生成 API 文档，方便前后端联调
   部署工具
   Docker + Docker Compose
   容器化部署，环境一致性强，简化运维流程
   
3. 核心功能设计
   3.1 用户管理模块
   3.1.1 核心能力
   用户生命周期管理：支持系统管理员创建租户用户、租户管理员创建自有用户，支持用户状态管理（通过数据字典维护：启用、禁用、锁定等）
   认证与安全：用户登录（账号密码校验）、密码重置（邮件 / 手机验证码，需权限校验）、登录日志记录（IP、时间、设备）
   信息管理：支持修改用户昵称、邮箱、手机号等基础信息，支持按租户、角色、状态筛选用户列表
   3.1.2 权限边界
   系统管理员：管理所有租户的用户（含创建、删除、状态修改）
   租户管理员：仅管理本租户下的用户（不可操作系统级用户）
   普通用户：仅查看 / 修改自身信息，无用户管理权限
   3.2 角色管理模块
   3.2.1 核心能力
   角色配置：支持创建自定义角色（如 "财务管理员""产品编辑"），设置角色描述，支持角色状态管理（通过数据字典维护：启用、禁用）
   用户关联：支持批量为用户分配角色，支持查看角色已关联的用户列表
   预设角色：系统默认提供 3 类角色，不可删除：
   超级管理员：拥有系统所有权限，包括查看所有租户的数据、系统级配置管理、跨租户数据操作权限
   租户管理员：拥有本租户下用户、角色管理权限，无系统菜单修改权限
   普通用户：仅拥有已分配的业务操作权限
   3.2.2 权限边界
   系统管理员：可创建系统级角色、租户级角色，管理所有角色权限
   租户管理员：仅可创建本租户下的角色，权限范围不可超出自身拥有的权限
   3.3 菜单管理模块
   3.3.1 核心能力
   菜单配置：支持系统管理员创建 / 修改 / 删除菜单，设置菜单名称、路由路径、图标、排序号、父级菜单（支持三级菜单）
   可见性控制：系统管理员可配置 “某菜单对哪些租户可见”，未配置的租户默认不可见
   权限绑定：菜单需与权限关联，用户仅能看到已拥有权限的菜单（结合角色权限判断）
   3.3.2 关键规则
   系统菜单保护：标记为 “系统菜单”（isSystem=1）的菜单，仅系统管理员可操作，租户无任何编辑权限
   租户菜单限制：租户不可创建菜单，仅能通过系统管理员配置 “可见菜单”，确保平台菜单结构统一
   3.4 权限管理模块
   3.4.1 权限粒度
   采用 “操作级” 权限粒度，每个权限对应一个具体操作，示例：
   用户管理：user:list（查看）、user:create（创建）、user:update（修改）、user:delete（删除）
   租户配置：tenant:config:view（查看配置）、tenant:config:update（修改配置）
   3.4.2 权限分配
   权限仅支持 “通过角色分配”，不支持直接分配给用户（避免权限混乱）
   角色权限修改后，关联用户的权限实时生效（无需重新登录）
   3.4.3 数据权限
   支持 “行级权限” 控制，示例：
   超级管理员：可查看所有租户的数据，无租户隔离限制
   租户管理员：仅能查看本租户的用户数据
   普通用户仅能查看自身的操作日志
   3.5 SAAS 租户模块
   3.5.1 核心能力
   租户管理：系统管理员可创建租户，设置租户名称、域名（支持子域名，如 tenant1.lightstack.com）、过期时间、状态（通过数据字典维护：启用、禁用、试用等）
   个性化配置：租户管理员可修改本租户的展示信息，包括：
   系统标题（如 “XX 企业管理平台”）
   Logo（支持上传图片，替换默认 Logo）
   主题色（支持选择预设色或自定义色值）
   登录页背景图（支持上传）
   版权信息（如 “©2025 XX 企业 版权所有”）
   数据隔离：租户数据通过 “tenant_id” 字段区分，所有业务表均包含该字段，确保租户间数据不互通
   3.5.2 资源控制
   系统管理员可配置租户的资源配额，示例：
   最大用户数（超出后不可创建新用户）
   最大角色数
   存储空间（用于 Logo、背景图等上传文件）

   3.6 数据字典模块
   3.6.1 核心能力
   字典管理：系统管理员可创建字典类型（如用户状态、租户状态等），维护字典项（键值对）
   字典配置：支持设置字典项的名称、值、排序、描述、是否启用
   系统使用：各模块状态字段统一使用数据字典，保证数据一致性
   3.6.2 预设字典
   用户状态：1-启用、2-禁用、3-锁定
   租户状态：1-启用、2-禁用、3-试用、4-过期
   角色状态：1-启用、2-禁用

   3.7 文件管理模块
   3.7.1 核心能力
   文件上传：支持租户上传 Logo、背景图等个性化文件
   格式限制：仅支持常见图片格式（jpg、png、gif），限制文件大小（如 2MB）
   存储管理：文件按租户分目录存储，支持删除无用文件
   3.7.2 安全机制
   路径安全：防止路径遍历攻击，文件名规范化处理
   权限校验：仅租户管理员可上传本租户文件

   3.8 操作日志模块
   3.8.1 核心能力
   日志记录：记录用户操作行为（登录、增删改操作、权限变更等）
   日志内容：操作用户、操作时间、操作模块、操作详情、IP 地址、User-Agent
   日志查询：支持按用户、时间范围、操作类型筛选查询
   3.8.2 权限边界
   系统管理员：可查看所有日志
   租户管理员：仅可查看本租户下的日志
   普通用户：仅可查看自身操作日志

4. 系统架构设计
   4.1 分层架构
   表现层（Controller）：处理 HTTP 请求，参数校验，响应格式化
   业务逻辑层（Service）：核心业务逻辑，权限校验，事务管理
   数据访问层（Repository）：数据库操作，数据映射
   模型层（Model）：数据结构定义，业务实体

   4.2 中间件设计
   认证中间件：JWT 令牌校验，用户身份识别
   权限中间件：基于 RBAC 的权限校验
   租户中间件：租户信息注入，数据隔离
   日志中间件：请求日志记录，操作审计
   限流中间件：API 请求频率限制

   4.3 响应格式
   统一响应格式：
   ```json
   {
     "code": 200,
     "message": "success",
     "data": {},
     "timestamp": 1672531200000
   }
   ```
   错误码定义：
   - 200: 成功
   - 400: 参数错误
   - 401: 未认证
   - 403: 权限不足
   - 404: 资源不存在
   - 500: 系统错误

5. 数据库设计
   5.1 设计原则
   数据隔离：所有业务表包含 tenant_id 字段，实现租户数据隔离
   数据一致性：不使用外键约束，通过应用层代码保证数据一致性
   索引优化：在查询频繁的字段上建立索引，提升查询性能
   字段规范：统一字段命名，使用下划线命名法
   软删除：重要数据表支持软删除，使用 deleted_at 字段

   5.2 核心表结构

   **租户管理表**
   - tenants: 租户信息表，存储租户基本信息、配置、资源限制等

   **用户管理表**
   - users: 用户表，支持租户隔离，包含用户基本信息、状态、登录信息等
   - user_roles: 用户角色关联表，实现用户与角色的多对多关系

   **角色权限管理表**
   - roles: 角色表，支持系统角色和租户角色
   - permissions: 权限表，定义系统中所有权限点
   - role_permissions: 角色权限关联表，实现角色与权限的多对多关系

   **菜单管理表**
   - menus: 菜单表，支持三级菜单结构，系统菜单保护机制
   - tenant_menus: 租户菜单可见性配置表，控制菜单对租户的可见性
   - role_menus: 角色菜单关联表，实现角色与菜单的多对多关系

   **数据字典表**
   - dict_types: 字典类型表，定义字典分类
   - dict_data: 字典数据表，存储具体的字典项

   **文件管理表**
   - files: 文件表，支持文件上传、存储路径管理、使用分类等

   **日志管理表**
   - operation_logs: 操作日志表，记录用户操作行为
   - login_logs: 登录日志表，记录用户登录信息

   **核心字段说明**
   - tenant_id: 租户隔离字段，所有业务表都包含此字段
   - isSystem: 系统标识字段，区分系统级数据和租户级数据
   - status: 状态字段，使用数据字典统一管理
   - created_at/updated_at: 时间戳字段，记录数据创建和更新时间
   - deleted_at: 软删除字段，支持数据恢复

   **索引设计**
   - 主键索引：所有表都有自增主键
   - 唯一索引：防止重复数据，如租户域名、用户名等
   - 查询索引：在频繁查询字段上建立索引，如 tenant_id、status 等
   - 关联索引：在关联表的外键字段上建立索引，提升关联查询性能

   **数据一致性**
   - 不使用数据库外键约束，通过应用层代码保证数据一致性
   - 在删除操作时，代码层面检查关联数据，防止数据孤岛
   - 使用事务确保关联数据的同时操作成功或失败

   详细的数据库表结构请参考 `doc/database_schema.sql` 文件

6. 安全设计
   6.1 认证安全
   密码加密：使用 bcrypt 加密存储用户密码
   JWT 安全：设置合理的过期时间，支持令牌刷新
   登录保护：登录失败次数限制，账户锁定机制

   6.2 权限安全
   最小权限原则：用户仅拥有必需的最小权限
   权限校验：所有 API 接口进行权限校验
   数据隔离：严格的租户数据隔离，防止越权访问

   6.3 接口安全
   参数校验：严格的输入参数校验，防止注入攻击
   CORS 配置：合理配置跨域请求
   限流保护：API 请求频率限制，防止恶意攻击

7. 部署方案
   7.1 环境要求
   操作系统：Linux（推荐 CentOS 7+/Ubuntu 18+）
   Go 版本：1.18+
   数据库：MySQL 8.0+
   缓存：Redis 6.0+
   反向代理：Nginx

   7.2 Docker 部署
   提供 Docker Compose 配置文件
   支持一键启动所有服务
   包含数据库初始化脚本
   支持环境变量配置

   7.3 生产环境
   负载均衡：支持多实例部署
   数据备份：数据库定期备份策略
   监控告警：系统性能监控，异常告警
   日志管理：集中式日志收集与分析