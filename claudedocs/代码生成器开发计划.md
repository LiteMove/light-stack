# 代码生成器开发计划

## 📋 项目概述

基于现有light-stack项目，开发一个完整的代码生成功能模块，支持从数据库表结构自动生成包含增删改查功能的后端API和前端页面，以及相应的菜单配置SQL。

## 🎯 功能目标

- ✅ 支持选择数据库表并分析表结构
- ✅ 提供可视化页面配置生成参数
- ✅ 生成完整的后端CRUD代码（Model、Service、Controller、Repository）
- ✅ 生成完整的前端页面（列表、表单、详情）
- ✅ 自动生成菜单配置SQL
- ✅ 支持代码预览和打包下载

## 🏗️ 技术架构

- **后端**: Go + Gin + GORM + Template Engine
- **前端**: Vue3 + TypeScript + Element Plus
- **模板引擎**: text/template + html/template
- **数据库**: 基于现有MySQL数据库

## 📅 开发计划

### Phase 1: 数据库设计和基础结构 (2-3天)

#### 1.1 创建数据库表结构
- [ ] 创建代码生成相关数据表
  - [ ] `gen_projects` - 代码生成项目表
  - [ ] `gen_table_configs` - 数据表配置表
  - [ ] `gen_table_columns` - 字段配置表
  - [ ] `gen_menu_configs` - 菜单配置表

#### 1.2 创建数据模型
- [ ] 创建 `internal/model/generator.go`
- [ ] 定义生成器相关的结构体和模型

#### 1.3 数据库执行SQL
- [ ] 创建数据库表结构 `doc/database_schema.sql`

**验收标准**: 数据库表创建成功，模型定义完整

---

### Phase 2: 后端核心功能开发 (4-5天)

#### 2.1 数据库表结构分析模块
- [ ] 创建 `internal/service/db_analyzer.go`
- [ ] 实现数据库连接和表结构查询
- [ ] 实现表字段信息获取
- [ ] 实现字段类型映射（MySQL -> Go类型）

**文件清单:**
```
internal/service/db_analyzer.go
internal/repository/db_analyzer.go
```

#### 2.2 代码生成配置管理
- [ ] 创建 `internal/service/gen_config_service.go`
- [ ] 实现配置的增删改查
- [ ] 实现配置验证逻辑
- [ ] 创建 `internal/repository/gen_config_repository.go`

**文件清单:**
```
internal/service/gen_config_service.go
internal/repository/gen_config_repository.go
internal/controller/gen_config_controller.go
```

#### 2.3 模板引擎设计
- [ ] 创建模板目录结构 `templates/`
- [ ] 设计模板变量和函数
- [ ] 创建 `internal/generator/template_engine.go`
- [ ] 实现模板加载和渲染功能

**目录结构:**
```
templates/
├── backend/
│   ├── model.go.tpl
│   ├── service.go.tpl
│   ├── controller.go.tpl
│   ├── repository.go.tpl
│   └── request.go.tpl
├── frontend/
│   ├── list.vue.tpl
│   ├── form.vue.tpl
│   ├── detail.vue.tpl
│   └── api.js.tpl
└── sql/
    └── menu.sql.tpl
```

#### 2.4 代码生成核心引擎
- [ ] 创建 `internal/generator/code_generator.go`
- [ ] 实现代码生成主逻辑
- [ ] 实现文件打包功能（ZIP）
- [ ] 实现生成结果存储

**文件清单:**
```
internal/generator/code_generator.go
internal/generator/template_engine.go
internal/generator/file_packager.go
```

#### 2.5 API接口开发
- [ ] 创建 `internal/controller/generator_controller.go`
- [ ] 实现数据库表列表接口
- [ ] 实现表结构分析接口
- [ ] 实现配置保存接口
- [ ] 实现代码生成接口
- [ ] 实现代码预览接口
- [ ] 实现文件下载接口

**API接口清单:**
```
GET    /api/gen/database/tables              - 获取数据库表列表
GET    /api/gen/database/tables/:name/columns - 获取表字段信息
POST   /api/gen/config                       - 保存生成配置
GET    /api/gen/config/:id                   - 获取配置详情
PUT    /api/gen/config/:id                   - 更新配置
DELETE /api/gen/config/:id                   - 删除配置
GET    /api/gen/configs                      - 获取配置列表
POST   /api/gen/generate                     - 生成代码
GET    /api/gen/preview/:configId            - 预览代码
GET    /api/gen/download/:taskId             - 下载代码包
GET    /api/gen/menus                        - 获取系统菜单树
```

**验收标准**: 所有API接口开发完成并通过测试

---

### Phase 3: 模板文件开发 (3-4天)

#### 3.1 后端代码模板
- [ ] 创建Model模板 `templates/backend/model.go.tpl`
- [ ] 创建Service模板 `templates/backend/service.go.tpl`
- [ ] 创建Controller模板 `templates/backend/controller.go.tpl`
- [ ] 创建Repository模板 `templates/backend/repository.go.tpl`
- [ ] 创建Request/Response模板 `templates/backend/request.go.tpl`

#### 3.2 前端代码模板
- [ ] 创建列表页面模板 `templates/frontend/list.vue.tpl`
- [ ] 创建表单页面模板 `templates/frontend/form.vue.tpl`
- [ ] 创建详情页面模板 `templates/frontend/detail.vue.tpl`
- [ ] 创建API接口模板 `templates/frontend/api.js.tpl`
- [ ] 创建TypeScript类型模板 `templates/frontend/types.ts.tpl`

#### 3.3 SQL和配置模板
- [ ] 创建菜单SQL模板 `templates/sql/menu.sql.tpl`
- [ ] 创建路由配置模板 `templates/config/routes.js.tpl`

#### 3.4 模板测试
- [ ] 创建模板单元测试
- [ ] 测试各种字段类型的模板渲染
- [ ] 测试复杂表结构的模板生成

**验收标准**: 所有模板文件创建完成，能够正确渲染各种类型的代码

---

### Phase 4: 前端页面开发 (4-5天)

#### 4.1 路由配置
- [ ] 在 `web/src/router/index.ts` 中添加代码生成器路由
- [ ] 配置路由权限

**路由结构:**
```
/generator
├── /tables          - 表选择页面
├── /config/:tableId - 配置页面
├── /preview/:configId - 预览页面
└── /history         - 历史记录页面
```

#### 4.2 表选择页面
- [ ] 创建 `web/src/views/generator/TableSelection.vue`
- [ ] 实现数据库表列表展示
- [ ] 实现表搜索和筛选
- [ ] 实现表选择和批量操作
- [ ] 实现表结构预览

#### 4.3 配置页面
- [ ] 创建 `web/src/views/generator/Configuration.vue`
- [ ] 实现基础信息配置表单
- [ ] 实现字段配置表格
- [ ] 实现菜单配置表单
- [ ] 实现配置保存和验证

#### 4.4 代码预览页面
- [ ] 创建 `web/src/views/generator/Preview.vue`
- [ ] 实现生成代码的语法高亮展示
- [ ] 实现代码文件树结构展示
- [ ] 实现代码搜索和导航

#### 4.5 历史记录页面
- [ ] 创建 `web/src/views/generator/History.vue`
- [ ] 实现配置历史记录列表
- [ ] 实现历史记录搜索和筛选
- [ ] 实现配置复制和重新生成

#### 4.6 公共组件
- [ ] 创建 `web/src/components/Generator/FieldConfigTable.vue`
- [ ] 创建 `web/src/components/Generator/MenuConfigForm.vue`
- [ ] 创建 `web/src/components/Generator/CodePreview.vue`
- [ ] 创建 `web/src/components/Generator/ProgressBar.vue`

#### 4.7 API接口封装
- [ ] 创建 `web/src/api/generator.js`
- [ ] 封装所有代码生成器相关的API调用
- [ ] 实现错误处理和loading状态管理

**文件清单:**
```
web/src/views/generator/
├── TableSelection.vue
├── Configuration.vue
├── Preview.vue
└── History.vue

web/src/components/Generator/
├── FieldConfigTable.vue
├── MenuConfigForm.vue
├── CodePreview.vue
└── ProgressBar.vue

web/src/api/generator.js
web/src/types/generator.ts
```

**验收标准**: 前端页面完整，用户体验良好，所有功能正常工作

---

### Phase 5: 集成测试和优化 (2-3天)

#### 5.1 功能测试
- [ ] 测试完整的代码生成流程
- [ ] 测试各种数据类型和表结构
- [ ] 测试生成代码的正确性
- [ ] 测试菜单SQL的正确性

#### 5.2 性能优化
- [ ] 优化大表结构的处理性能
- [ ] 优化代码生成速度
- [ ] 优化文件打包和下载
- [ ] 优化前端页面加载速度

#### 5.3 错误处理
- [ ] 完善错误处理机制
- [ ] 添加友好的错误提示
- [ ] 实现操作日志记录

#### 5.4 文档编写
- [ ] 编写用户使用手册
- [ ] 编写开发者文档
- [ ] 编写API接口文档

**验收标准**: 系统稳定运行，性能满足要求，文档完整

---

### Phase 6: 部署和上线 (1天)

#### 6.1 生产环境配置
- [ ] 配置生产环境数据库
- [ ] 配置文件存储路径
- [ ] 配置日志和监控

#### 6.2 权限配置
- [ ] 添加代码生成器菜单到系统
- [ ] 配置相关权限
- [ ] 测试权限控制

#### 6.3 用户培训
- [ ] 准备用户培训材料
- [ ] 进行用户培训
- [ ] 收集用户反馈

**验收标准**: 系统成功上线，用户能够正常使用

---

## 📁 项目文件结构

```
light-stack/
├── internal/
│   ├── model/
│   │   └── generator.go                 # 生成器数据模型
│   ├── service/
│   │   ├── db_analyzer.go              # 数据库分析服务
│   │   └── gen_config_service.go       # 配置管理服务
│   ├── repository/
│   │   ├── db_analyzer.go              # 数据库分析仓储
│   │   └── gen_config_repository.go    # 配置管理仓储
│   ├── controller/
│   │   ├── gen_config_controller.go    # 配置管理控制器
│   │   └── generator_controller.go     # 代码生成控制器
│   └── generator/
│       ├── code_generator.go           # 代码生成器
│       ├── template_engine.go          # 模板引擎
│       └── file_packager.go           # 文件打包器
├── templates/                          # 模板文件目录
│   ├── backend/                       # 后端代码模板
│   ├── frontend/                      # 前端代码模板
│   └── sql/                          # SQL模板
├── web/src/
│   ├── views/generator/               # 前端页面
│   ├── components/Generator/          # 专用组件
│   ├── api/generator.js              # API接口
│   └── types/generator.ts            # TypeScript类型
└── migrations/                        # 数据库迁移文件
```

## 🔍 关键技术点

### 1. 数据库反射
```go
// 示例：获取表结构信息
func (s *DBAnalyzerService) GetTableColumns(tableName string) ([]ColumnInfo, error) {
    query := `
        SELECT
            COLUMN_NAME,
            COLUMN_TYPE,
            IS_NULLABLE,
            COLUMN_DEFAULT,
            COLUMN_COMMENT,
            COLUMN_KEY
        FROM INFORMATION_SCHEMA.COLUMNS
        WHERE TABLE_SCHEMA = ? AND TABLE_NAME = ?
        ORDER BY ORDINAL_POSITION
    `
    // 实现逻辑...
}
```

### 2. 模板变量设计
```go
type TemplateData struct {
    PackageName  string        // 包名
    ClassName    string        // 类名
    TableName    string        // 表名
    BusinessName string        // 业务名
    FunctionName string        // 功能名
    Author       string        // 作者
    Date         string        // 日期
    Fields       []FieldInfo   // 字段信息
    MenuConfig   MenuConfig    // 菜单配置
    HasQuery     bool         // 是否有查询字段
    QueryFields  []FieldInfo   // 查询字段
    ListFields   []FieldInfo   // 列表字段
    FormFields   []FieldInfo   // 表单字段
}
```

### 3. 前端状态管理
```typescript
// 使用Pinia进行状态管理
export const useGeneratorStore = defineStore('generator', {
  state: () => ({
    selectedTables: [],
    currentConfig: null,
    generationProgress: 0,
    generatedFiles: []
  }),

  actions: {
    async generateCode(configId: number) {
      // 实现代码生成逻辑
    }
  }
})
```

## ⚠️ 注意事项

1. **安全性**: 确保模板注入安全，避免恶意代码生成
2. **性能**: 大表处理时注意内存和CPU使用
3. **兼容性**: 确保生成的代码符合项目规范
4. **扩展性**: 设计时考虑后续功能扩展
5. **测试**: 充分测试各种边界情况

## 🎯 成功指标

- [ ] 能够成功分析数据库表结构
- [ ] 能够生成完整可运行的后端CRUD代码
- [ ] 能够生成完整可用的前端页面代码
- [ ] 能够生成正确的菜单配置SQL
- [ ] 生成的代码符合项目代码规范
- [ ] 用户操作流程简单直观
- [ ] 系统响应速度满足要求
- [ ] 代码生成成功率 > 95%

## 📞 联系方式

如在开发过程中遇到问题，请及时沟通解决。

---

*本开发计划将根据实际开发进度进行调整和优化*